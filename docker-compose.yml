version: '3.8'

services:
  ingestion:
    build:
      context: .
      dockerfile: services/ingestion/Dockerfile
    container_name: gravix-ingestion
    restart: always
    ports:
      - "8090:8080"
    volumes:
      - ./data:/app/data
    command: [ "./ingestion-service", "--base-dir", "/app/data" ]
    environment:
      - API_KEY=secret-token-123
      - S3_ENDPOINT=http://minio:9000
      - S3_REGION=us-east-1
      - S3_BUCKET=gravix
      - S3_ACCESS_KEY=admin
      - S3_SECRET_KEY=password123
    depends_on:
      - minio

  init-minio:
    image: minio/mc:latest
    container_name: gravix-init-minio
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set myminio http://minio:9000 admin password123;
      /usr/bin/mc mb myminio/gravix;
      exit 0;
      "
    depends_on:
      - minio

  trino:
    image: trinodb/trino:351
    container_name: gravix-trino
    ports:
      - "8081:8080" # Trino UI
    volumes:
      - ./storage/trino/config:/etc/trino
      - ./storage/trino/catalog:/etc/trino/catalog
      - ./data/warehouse:/data/warehouse
      - ./data/raw:/data/raw
  cube:
    image: cubejs/cube:latest
    container_name: gravix-cube
    ports:
      - "4000:4000"
    environment:
      - CUBEJS_DB_TYPE=trino
      - CUBEJS_DB_HOST=gravix-trino
      - CUBEJS_DB_PORT=8080
      - CUBEJS_DB_PRESTO_CATALOG=gravix
      - CUBEJS_DB_NAME=raw
      - CUBEJS_DB_USER=trino
      - CUBEJS_DEV_MODE=true
    volumes:
      - ./cube/cube.js:/cube/conf/cube.js
      - ./cube/model:/cube/conf/model
    depends_on:
      - trino

  load-generator:
    build:
      context: .
      dockerfile: services/load_generator/Dockerfile
    container_name: gravix-load-generator
    command: ["./load-generator", "--target", "http://ingestion:8080/api/v1/facts", "--api-key", "secret-token-123", "--qps", "5", "--concurrency", "2"]
    depends_on:
      - ingestion

  prometheus:
    image: prom/prometheus:latest
    container_name: gravix-prometheus
    volumes:
      - ./storage/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    restart: always

  grafana:
    image: grafana/grafana:latest
    container_name: gravix-grafana
    ports:
      - "3000:3000"
    volumes:
      - ./storage/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
    restart: always

  minio:
    image: minio/minio:latest
    container_name: gravix-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=password123
    volumes:
      - ./data/minio:/data
    command: server /data --console-address ":9001"
    restart: always
