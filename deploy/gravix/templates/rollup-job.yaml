apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-rollup
spec:
  schedule: {{ .Values.rollupJob.schedule | quote }}
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: rollup
              image: "{{ .Values.rollupJob.image.repository }}:{{ .Values.rollupJob.image.tag }}"
              imagePullPolicy: {{ .Values.rollupJob.image.pullPolicy }}
              command: ["./rollup-job"]
              args:
                - "--process-time"
                - "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
              env:
                - name: S3_ENDPOINT
                  value: {{ .Values.global.storage.endpoint | quote }}
                - name: S3_REGION
                  value: {{ .Values.global.storage.region | quote }}
                - name: S3_BUCKET
                  value: {{ .Values.global.storage.bucket | quote }}
                - name: S3_ACCESS_KEY
                  value: {{ .Values.global.storage.accessKey | quote }}
                - name: S3_SECRET_KEY
                  value: {{ .Values.global.storage.secretKey | quote }}
          restartPolicy: OnFailure
