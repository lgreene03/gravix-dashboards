groups:
  - name: gravix_ingestion
    rules:
      - alert: IngestionHighErrorRate
        expr: |
          sum(rate(ingestion_requests_total{status=~"5.."}[5m]))
          /
          sum(rate(ingestion_requests_total[5m]))
          > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Ingestion error rate above 5%"
          description: "The ingestion service is returning >5% server errors over the last 5 minutes."

      - alert: IngestionDown
        expr: up{job="ingestion"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Ingestion service is down"
          description: "The ingestion service has been unreachable for 2 minutes."

      - alert: IngestionHighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(ingestion_fsync_duration_seconds_bucket[5m])) by (le)
          ) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Ingestion fsync latency P95 above 500ms"
          description: "Disk write latency is elevated, which may indicate storage issues."

  - name: gravix_rollup
    rules:
      - alert: RollupStaleData
        expr: |
          time() - max(rollup_duration_seconds) > 600
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Rollup job may be stalled"
          description: "No rollup job has reported a duration metric in the last 10 minutes."

      - alert: RollupSlowExecution
        expr: rollup_duration_seconds > 120
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "Rollup job took over 2 minutes"
          description: "A rollup job execution took {{ $value }}s, which may indicate growing data volume."

  - name: gravix_infrastructure
    rules:
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes{job="ingestion"} > 512 * 1024 * 1024
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Ingestion service memory above 512MB"
          description: "The ingestion service is using {{ $value | humanize1024 }}B of memory."

      - alert: HighGoroutineCount
        expr: go_goroutines{job="ingestion"} > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Ingestion goroutine count above 1000"
          description: "High goroutine count ({{ $value }}) may indicate a goroutine leak."
